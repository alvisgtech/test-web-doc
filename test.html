<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Locator with OneMap</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .location {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .location h2 {
            margin: 0;
            font-size: 18px;
        }
        .location p {
            margin: 5px 0;
        }
        a {
            color: #007BFF;
            text-decoration: none;
        }
    </style>
</head>
<body>

<h1>Available Buildings</h1>
<div id="locations"></div>

<script>
    var apiKey = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIyOTIwNDE1YWFjY2ViNzA5OGZmYTQ4MTg5ZDNmNTRiZCIsImlzcyI6Imh0dHA6Ly9pbnRlcm5hbC1hbGItb20tcHJkZXppdC1pdC0xMjIzNjk4OTkyLmFwLXNvdXRoZWFzdC0xLmVsYi5hbWF6b25hd3MuY29tL2FwaS92Mi91c2VyL3Bhc3N3b3JkIiwiaWF0IjoxNzI0NzY1OTM0LCJleHAiOjE3MjUwMjUxMzQsIm5iZiI6MTcyNDc2NTkzNCwianRpIjoiVURmTkV3ME1wd1ZjWnREcCIsInVzZXJfaWQiOjQ0MjQsImZvcmV2ZXIiOmZhbHNlfQ.anQ88CPK2eOQWaPDFFyd3zzzaxlNdjAnCJUOUcjwILE'; // Replace with your OneMap API key

    var buildings = [
        {name: "Building 1", lat: 1.3521, lon: 103.8198, seatsAvailable: 5, deeplink: "myapp://building1"}, // Central Singapore
        {name: "Building 2", lat: 1.3644, lon: 103.9915, seatsAvailable: 8, deeplink: "myapp://building2"}, // Pasir Ris
        {name: "Building 3", lat: 1.2839, lon: 103.8514, seatsAvailable: 0, deeplink: "myapp://building3"}, // Marina Bay Sands
        {name: "Building 4", lat: 1.3776, lon: 103.7641, seatsAvailable: 12, deeplink: "myapp://building4"}  // Woodlands
    ];

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var userLat = position.coords.latitude;
            var userLon = position.coords.longitude;

            // Initialize an array to store promises for the distance calculation
            var distancePromises = buildings.map(function(building) {
                // Build the API request URL
                var url = `https://developers.onemap.sg/privateapi/routingsvc/route?start=${userLon},${userLat}&end=${building.lon},${building.lat}&routeType=walk&token=${apiKey}`;

                // Return a fetch promise
                return fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Check if the response is valid and calculate the distance
                        if (data.route_summary && data.route_summary.total_distance) {
                            building.distance = data.route_summary.total_distance / 1000; // Convert meters to kilometers
                        } else {
                            building.distance = Infinity; // Handle error cases
                        }
                    });
            });

            // Wait for all distance calculations to complete
            Promise.all(distancePromises).then(function() {
                // Sort buildings by distance (ascending order)
                buildings.sort(function(a, b) {
                    return a.distance - b.distance;
                });

                // Display the sorted list
                var locationContainer = document.getElementById("locations");
                buildings.forEach(function(building) {
                    var locationDiv = document.createElement("div");
                    locationDiv.className = "location";
                    locationDiv.innerHTML = `
                        <h2>${building.name}</h2>
                        <p>Seats available: ${building.seatsAvailable}</p>
                        <p>Distance: ${building.distance.toFixed(2)} km</p>
                        <p><a href="${building.deeplink}">Book Now</a></p>
                    `;
                    locationContainer.appendChild(locationDiv);
                });
            });

        }, function(error) {
            alert("Geolocation failed: " + error.message);
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }
</script>

</body>
</html>
